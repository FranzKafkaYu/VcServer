name: Build APK

on:
  workflow_dispatch:
    inputs:
      release_tag:
        required: false
        type: string
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建和上�?release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Setup Keystore
      if: github.event.inputs.release_tag != ''
      env:
        KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
      run: |
        if [ -n "$KEYSTORE_BASE64" ]; then
          echo "Creating jks directory..."
          mkdir -p app/jks
          echo "Decoding keystore file..."
          # 移除所有换行符和回车符，但保留空格（base64可能包含空格）         
          echo "$KEYSTORE_BASE64" | tr -d '\n\r' | base64 -d > app/jks/release
          chmod 600 app/jks/release
          echo "Keystore file created successfully"
          echo "Keystore file size: $(stat -c%s app/jks/release) bytes"
          echo "First 100 bytes (hex): $(head -c 100 app/jks/release | xxd -p | head -c 200)"
          echo "Validating keystore file..."
          # 先尝试JKS格式
          if keytool -list -v -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype JKS > /dev/null 2>&1; then
            echo "Keystore file is valid (JKS format)"
            keytool -list -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype JKS | grep -A 1 "Alias name" || echo "Warning: Could not list aliases"
          # 如果JKS失败，尝试PKCS12格式
          elif keytool -list -v -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype PKCS12 > /dev/null 2>&1; then
            echo "Keystore file is valid (PKCS12 format)"
            keytool -list -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype PKCS12 | grep -A 1 "Alias name" || echo "Warning: Could not list aliases"
          else
            echo "ERROR: Keystore file validation failed!"
            echo "Attempting to show keytool error details..."
            echo "Trying JKS format:"
            keytool -list -v -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype JKS 2>&1 || true
            echo "Trying PKCS12 format:"
            keytool -list -v -keystore app/jks/release -storepass "$KEYSTORE_PASSWORD" -storetype PKCS12 2>&1 || true
            exit 1
          fi
        else
          echo "Warning: KEYSTORE_BASE64 secret not found, skipping keystore setup"
        fi
      
    - name: Clean Gradle cache (optional, for fresh builds)
      run: ./gradlew --stop || true
      
    - name: Build Release APK
      if: github.event.inputs.release_tag != ''
      env:
        RELEASE_STORE_FILE: app/jks/release
        RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
        RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
      run: ./gradlew assembleRelease
      
    - name: Build Debug APK
      if: github.event.inputs.release_tag == ''
      run: ./gradlew assembleDebug
      
    - name: Find and upload APK
      run: |
        # 判断构建类型并设置路径
        if [ -n "${{ github.event.inputs.release_tag }}" ]; then
          BUILD_TYPE="release"
          APK_DIR="app/build/outputs/apk/release"
        else
          BUILD_TYPE="debug"
          APK_DIR="app/build/outputs/apk/debug"
        fi
        
        # 查找 APK 文件（Gradle 已自动命名为 buildType-版本号-commit.apk）
        APK_FILE=$(find "$APK_DIR" -name "*.apk" -type f | head -1)
        
        if [ -z "$APK_FILE" ]; then
          echo "ERROR: No APK file found in $APK_DIR"
          exit 1
        fi
        
        echo "Found APK: $APK_FILE"
        echo "APK_PATH=$APK_FILE" >> $GITHUB_ENV
        echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.BUILD_TYPE }}-apk
        path: ${{ env.APK_PATH }}
        retention-days: 30

    - name: Upload to release
      uses: softprops/action-gh-release@v1
      if: github.event.inputs.release_tag != ''
      with:
        files: ${{ env.APK_PATH }}
        tag_name: ${{ github.event.inputs.release_tag }}
        name: Release ${{ github.event.inputs.release_tag }}
        prerelease: true
        token: ${{ secrets.GITHUB_TOKEN }}
